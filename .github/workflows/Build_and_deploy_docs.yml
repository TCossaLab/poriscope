# .github/workflows/pages.yml
name: Build & Deploy Sphinx Docs to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install system deps (optional: Graphviz for dot diagrams)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y graphviz

      - name: Install Python deps (Sphinx + your package)
        run: |
          python -m pip install --upgrade pip
          # If you have docs/requirements.txt, use it; otherwise install a sane default stack
          if [ -f docs/requirements.txt ]; then
            pip install -r docs/requirements.txt
          else
            pip install sphinx furo myst-parser sphinx-autodoc-typehints
          fi
          # Install your package so autodoc can import it
          pip install -e .

      # (Optional) Generate API stubs with sphinx-apidoc if you use it
      # - name: Generate API docs
      #   run: |
      #     sphinx-apidoc -o docs/api src/your_package_name

      - name: Build Sphinx HTML
        # Adjust paths if your sources/build dirs differ
        run: |
          sphinx-build -b html docs docs/_build/html
        env:
          SPHINXOPTS: -W --keep-going  # drop -W if you don't want warnings to fail the build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload the built HTML, not the whole repo
          path: docs/_build/html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
