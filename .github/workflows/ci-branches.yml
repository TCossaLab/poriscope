name: CI (Branches)

on:
  push:
    branches:
      - develop
      - 'feature/*'
      - 'bugfix/*'

permissions:
  contents: write  # needed for auto-commit on push

# Concurrency cancellation per branch
concurrency:
  group: ci-branches-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick:
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen  # run Qt without a display
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install system libs for Qt
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libgl1 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            xvfb

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.10'
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Ruff + Black (auto-fix)
        run: |
          ruff check . --fix
          black .

      - name: Commit style fixes if any
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "style: auto-fix (ruff --fix, black)"
            git push
          fi

      - name: Run tests (no slow/e2e) under Xvfb
        run: |
          xvfb-run -a pytest -q -m "not e2e and not slow"
